#!/bin/bash

# SecureVPN Web Application Startup Script

echo "üöÄ –ó–∞–ø—É—Å–∫ SecureVPN Web Application..."

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é webapp
cd "$(dirname "$0")"

# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
if [ -d "venv" ]; then
    echo "üì¶ –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
    source venv/bin/activate
else
    echo "‚ùå –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!"
    echo "–í—ã–ø–æ–ª–Ω–∏—Ç–µ: python3 -m venv venv && source venv/bin/activate && pip install -r requirements.txt"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
if ! python -c "import flask, flask_cors, requests" 2>/dev/null; then
    echo "üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    pip install -r requirements.txt
fi

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
pkill -f "python backend/app.py" 2>/dev/null || true

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä
echo "üåê –ó–∞–ø—É—Å–∫ VPN –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞..."
echo "üìç –°–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: http://localhost:5000"
echo "üìä –õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ server.log"
echo "‚èπÔ∏è  –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: pkill -f 'python backend/app.py'"

# –ó–∞–ø—É—Å–∫–∞–µ–º –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
nohup python backend/app.py > server.log 2>&1 &

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
if curl -s http://localhost:5000/api/status > /dev/null; then
    echo "‚úÖ –°–µ—Ä–≤–µ—Ä —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!"
    echo "üîó –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ: http://localhost:5000"
    echo ""
    echo "üéØ –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:"
    echo "   ‚Ä¢ –í—ã–±–æ—Ä VPN —Å–µ—Ä–≤–µ—Ä–æ–≤ –∏–∑ 5 –ª–æ–∫–∞—Ü–∏–π"
    echo "   ‚Ä¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ/–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –æ–¥–Ω–∏–º –∫–ª–∏–∫–æ–º"
    echo "   ‚Ä¢ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏"
    echo "   ‚Ä¢ –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å"
    echo ""
    echo "üìã API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:"
    echo "   ‚Ä¢ GET  /api/status  - —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"
    echo "   ‚Ä¢ GET  /api/servers - —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤"
    echo "   ‚Ä¢ POST /api/connect - –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ VPN"
    echo "   ‚Ä¢ POST /api/disconnect - –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç VPN"
    echo "   ‚Ä¢ GET  /api/stats   - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞!"
    echo "üìã –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: cat server.log"
fi